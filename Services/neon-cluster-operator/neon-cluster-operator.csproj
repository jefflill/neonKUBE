<Project Sdk="Microsoft.NET.Sdk.Web">

    <PropertyGroup>
        <TargetFramework>net7.0</TargetFramework>
        <OutputType>Exe</OutputType>
        <RootNamespace>NeonClusterOperator</RootNamespace>
        <IsPackable>false</IsPackable>
        <ServerGarbageCollection>true</ServerGarbageCollection>
        <ConcurrentGarbageCollection>true</ConcurrentGarbageCollection>
        <AssemblyName>neon-cluster-operator</AssemblyName>
        <Configurations>Debug;Release</Configurations>
        <NoWarn>$(NoWarn);CS2002</NoWarn>
    </PropertyGroup>

    <ItemGroup>
        <Compile Include="$(SolutionDir)\Lib\Neon.Kube.BuildInfo\AssemblyAttributes.cs" Link="Properties\AssemblyAttributes.cs" />
        <Compile Include="$(SolutionDir)\Lib\Neon.Kube.BuildInfo\AssemblyInfo.cs" Link="Properties\AssemblyInfo.cs" />
    </ItemGroup>

    <ItemGroup>
        <Protobuf Include="Protos/**/*.proto" OutputDir="$(ProjectDir)" GrpcServices="Client" />
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="DnsClient" Version="1.6.1" />
        <PackageReference Include="Google.Protobuf" Version="3.22.0" />
        <PackageReference Include="Grpc.Net.Client" Version="2.51.0" />
        <PackageReference Include="Grpc.Tools" Version="2.52.0">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="JsonDiffPatch" Version="2.0.61" />
        <PackageReference Include="Minio" Version="4.0.7" />
        <PackageReference Include="NSwag.MSBuild" Version="13.18.2">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="OpenTelemetry" Version="1.4.0" />
        <PackageReference Include="OpenTelemetry.Instrumentation.GrpcCore" Version="1.0.0-beta.5" />
        <PackageReference Include="OpenTelemetry.Instrumentation.Quartz" Version="1.0.0-alpha.1" />
        <PackageReference Include="Npgsql.OpenTelemetry" Version="7.0.2" />
        <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="7.0.3" />
        <PackageReference Include="prometheus-net.DotNetRuntime" Version="4.4.0" />
        <PackageReference Include="Quartz" Version="3.6.2" />
        <PackageReference Include="Neon.Common" Version="10000.1.3017-dev-master" />
        <PackageReference Include="Neon.Service" Version="10000.1.3017-dev-master" />
    </ItemGroup>

    <ItemGroup>
        <ProjectReference Include="..\..\Lib\Neon.Kube.BuildInfo\Neon.Kube.BuildInfo.csproj" />
        <ProjectReference Include="..\..\Lib\Neon.Kube.Operator\Neon.Kube.Operator.csproj" />
        <ProjectReference Include="..\..\Lib\Neon.Kube.Resources\Neon.Kube.Resources.csproj" />
        <ProjectReference Include="..\..\Lib\Neon.Kube\Neon.Kube.csproj" />
    </ItemGroup>

    <ItemGroup>
        <Folder Include="config.gitignore\" />
    </ItemGroup>

    <ItemGroup>
        <None Update="Properties\launchSettings.json">
            <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
            <CopyToPublishDirectory>Never</CopyToPublishDirectory>
        </None>
    </ItemGroup>

    <Target Name="PublishCRDs" AfterTargets="GenerateAfterBuild">
        <Message Importance="high" Text="Publish CRDs to: Neon.Kube.Setup" />
        <Exec Command="neon-build rm &quot;$(SolutionDir)Lib\Neon.Kube.Setup\Resources\Helm\$(MSBuildProjectName)\crds\*&quot;" />
        <Exec Command="neon-build publish-files &quot;$(ProjectDir)config.gitignore\crds\*&quot; &quot;$(NK_ROOT)\Lib\Neon.Kube.Setup\Resources\Helm\$(MSBuildProjectName)\crds&quot; --exclude-kustomize" />
    </Target>

    <Target Name="NSwag" AfterTargets="BeforeBuild">
        <Exec Command="$(NSwagExe) openapi2csclient /classname:HarborClient /namespace:NeonClusterOperator.Harbor /input:../../Lib/Neon.Kube/Harbor/swagger.json /output:HarborClient.mg.cs" />
    </Target>

	<!--
	$todo(jefflill): 02-25-2023
	
	I've refactored how cluster manifests are handled.  Before 02-25-2023, we included
	this manifest in the [Neon.Kube.Setup] and [neon-cluster-operator] projects as resources.
	This resulted in a chicken-and-egg issue where rebuilding the manifest in neonCLOUD
	would change the manifest, which was result in a change to [neon-cluster-operator]
	which would cause the manifest to change when rebuilt, and so on...
	
	We're refactoring this by having our installers (built in neonCLOUD) include the
	[cluster-manifest.json] file in the installed application folder so [neon-cli]
	and [neon-desktop] can read the file from there or fallback to downloading it
	from S3.
	
	The problem is that this file is git-ignored, so we need a way to remove it from
	all checked out repos.  That's what this build target does.
	
	This target is temporary and can be removed in a few months.
	-->

	<Target Name="DeleteClusterManifest" BeforeTargets="Build">
		<Message Importance="high" Text="Delete: Resources/cluster-manifest.json" Condition="Exists('$(ProjectDir)Resources\cluster-manifest.json')" />
		<Delete Files="$(ProjectDir)Resources\cluster-manifest.json" Condition="Exists('$(ProjectDir)Resources\cluster-manifest.json')" />
	</Target>

</Project>
